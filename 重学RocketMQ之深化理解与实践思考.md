# 重学RocketMQ之深化理解与实践思考

## 引言

最近在零拷贝、分布式事务消息，架构的认知上有了新的理解，于是重新打算学习一下RocketMQ，关于RocketMQ的文章已经写了三篇:

-  《消息队列引论》

- 《RocketMQ学习笔记(一) 初遇篇》
- 《RocketMQ学习笔记(二) 相识篇》

关于零拷贝这里讲了三篇《译: 通过零拷贝实现高效数据传输》、《操作系统与通用计算机组成原理简论》、《NIO 学习笔记(一)初遇》，本篇尝试融合这几篇的知识点，做到理论与实践相融合。

## 概述

按照最初的设想是消息队列引论，总体论述消息队列，然后后面跟kafak、RabbitMQ、RocketMQ，到现在为止只学了RocketMQ，在《消息队列引论》里面我们首先讲消息队列的定位，首先消息队列是一个队列，队列是一种组织数据结构的形式，也就是数据结构，这种数据结构具备先入先出的特点，但是在消息队列下面的语境下面，更多表达的是是一种生产者消费者模型的概念，也就是说在消息队列里面一般都会有生产者和消费者，从名字上就可以推断出来，生产者负责生产消息，消费者负责消费消息，还有一个存储消息的地方，在RocketMQ里面这个存储消息的地方叫Broker，那么问题来了， 这三个是如何联系起来的呢? 答案是NameServer:

![](https://a.a2k6.com/gerald/i/2024/08/14/37vi.png)



在我们的图片中生产者通过NameServer将消息存储到Broaker中，消费者通过NameServer对消息进行消费，在这种语境下消息好像是没有区分的一样，生产者生产消息，消息到达Broker之后被消费者消费，实际中的RocketMQ并不是这样，为了对消息进行区分RocketMQ引入topic(主题)和tag(标签)的概念，主题用于标识同一类业务的逻辑信息，主要作用有:

- 定义数据的分类隔离: 也就是将不同的业务类型数据拆分到不同的主题中管理。
- 定义数据的身份和权限:  RocketMQ的消息本身是匿名无身份的，同一分类的消息使用相同的主题来做身份识别和权限管理。

写到这里想起上海的垃圾分类，何尝不是一种分类隔离呢:

![](https://a.a2k6.com/gerald/i/2024/08/16/4hv60.png)

不同的垃圾桶放不同类型的垃圾，不同的主题放不同类型的消息:

![](https://a.a2k6.com/gerald/i/2024/08/16/p3ow.png)

topic容纳的是一种类型的信息，我们可以将其看做是一个分类标准，但有时候一个大分类还不够，我们需要对信息进一步分类，RocketMQ在主题的基础上为我们提供了tag，我们可以将Topic当做一级分类，Tag当做二级分类。

![](https://a.a2k6.com/gerald/i/2024/08/16/5jqq5.png)

这里说的分类是一种业务上的划分，订单状态流转我们可以将其放入到一个主题(topic)，而到达对应的状态则属于对应的标签(tag)。

## RocketMQ的消息类型

而对于RocketMQ本身又可以根据传输特性将消费分为:普通消息、顺序消息、事务消息、定时/延时消息。

### 普通消息

- 普通消息:  普通消息的普通是相对于顺序消息、事务消息、延时消息来说的，对于普通消息来说它的生命周期有四个阶段: 初始化、待消费、消费中、消费提交。

​	![](https://a.a2k6.com/gerald/i/2024/08/16/wd7z.png)



- 顺序消息
- 事务消息
- 定时/延时消息







## 主从与刷盘方式

在我们的图片里面出现了master和slave这两个单词，从字面意义上推断也就是主从，用于实现高可用(high availability)，也就是说主节点会向从节点复制数据，复制方式有两种: 一种同步，一种是异步。

