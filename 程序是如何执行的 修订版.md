# 程序是如何运行的(一)

[TOC]

## 前言

写本篇的时候想起我刚面实习的时候，面试官问编译原理的知识，我当时只隐约记得常量折叠，所谓常量折叠简单的说就是将一些在编译期能确定的计算过程放在编译期就计算完成，而不用将计算工程都放在运行期。老实说，我是一个好奇心比较强的人，有些问题出现在眼前，可能当前没有时间的话，这个问题会一直放在我的脑海，直到有时间给出答案为止。我也想起刚毕业的时候加入的一些QQ群，我会饶有兴致的跟别人去争论，但是大多数情况下得到的并不是有益的讨论，大多数人都无意跟你争论，得到的基本是嘲讽。当时一个群里的人嘲讽我，是大厂的人嘛？ 这些就大厂能用到。现在想想这位兄弟某种程度上说的也是，所以这篇文章算是纯粹的满足我自己的好奇心，基本上面试也问不到。我也想起我大学时思考的两个问题: 

- 什么是机器语言？
- 程序是如何被执行的？

我时常带着第一个问题去咨询我的大学老师，但老师的回答却常常不让我满意，有一个老师说机器语言就是打孔卡上写好送入机器执行，像下面这样: 

![image-20230206112928983](https://user-images.githubusercontent.com/45529222/218033422-9956f07e-7acf-4472-a402-ca7a9617016f.png)

![image-20230206113141560](https://user-images.githubusercontent.com/45529222/218033457-12f2178b-12e6-48b0-b9b3-32423365634c.png)


这两张截图来自B站视频: https://www.bilibili.com/video/BV1i64y1M7Sc/。有兴致的可以看下。当时的这个回答，我脑补的场景大致就是上面两张图的模糊版本。 但我感觉我的问题仍然被完全回答，我后面又想那打孔纸带上的就是机器语言吗？ 既然是一种语言有什么样的语法、单词呢？现在我们构建软件基本上会选择高级语言：C#、C++、C、Python、Java等。按照一般的理解计算机是无法直接识别我们编写的文本的，所以还是需要有编译器来将我编写的文本编译成计算机能够识别的代码。会有人说计算机只认识1和0。计算机也有好几个部分，那这个1和0究竟是谁来识别的呢？让我们从计算机体系结构讲起。

## 从计算机体系(系统)结构讲起

我们先来理解结构这个词，再讨论计算机体系结构。事实上在计算机领域，结构和架构出现的频率是蛮高的，比如数据结构，计算机体系结构，软件架构，架构师等等。前面的文章里面我们已经讨论过数据结构，软件架构:

- 且谈软件架构  https://juejin.cn/post/6844904089692700680
- 数据结构与算法分析学习笔记(一) 数据结构简论  https://juejin.cn/post/6980929046733553695

在《且谈软件架构》中我们谈到架构对应的英语单词是Architecture，而结构对应的单词是structure。在这篇文章中我们提到:

> Architecture: *The* *architecture* *of* *something* *is* *its* *structure*

即某物的结构就是架构。参考的是柯林斯词典[1], 但今天重翻这篇文章的时候，又翻了几个词典，在《牛津高阶英汉双解 第七版》中没有这样的语义，在这个词典中关于Architecture这个单词的语义有以下几个：

- the art and study of designing buildings  建筑学 

  	 例句是:  to study architecture。

- the design or style of a building or buildings   建筑设计，建筑风格。
- the design and structure of a compute system 计算机行业的名词，体系结构；(总体、层次)结构

但是从字面上意思来看应当是计算机系统的结构与设计更好，层次结构，总体结构也还说的过去 ,  体系结构就有些怪怪的，因为体系在汉语词典里的意思是:"整体结构", 所以构词的时候，就是结构的结构。我的考据癖发作，我想这个词一定是外来词，从其他语言引入的，所以我一眼看上去才会感觉这个词有点体会不到意思，于是我咨询了下chatGPT(强大的AI问答产生器), 这确实是一个引进中文的词，原词为system architecture，到后面不知道怎么变成了体系结构。我们理解成系统结构的话，就好理解的多， 那什么是系统呢？ 我认为这是一个组织的整体，由多个相互作用的部分组成，以达到特定的目标或功能。

那结构呢，我们看下structure这个词在牛津词典中的意思: 

> the way in which the parts of sth are connected together, arranged or organized; a particular arrangement of parts
>
> 某物各部分连接或排列、组织的方式; 各部分特定的排列方式

那现在我们就可以来审视计算机系统(体系)结构这个词了，当我们说起计算机系统结构的时候，我们说的是什么?  我想应当是各个层次的结构, 如下图所示:

![通用计算机系统的层次结构](https://foxsen.github.io/archbase/images/chapter1/hierarchy.png)

图片来自于《计算机体系结构基础》。当我们将计算机系统结构分层，程序是如何运行的就明朗了起来，普通人接触的多就是各种各样的应用程序。这些应用程序本身主要是由不同的高级语言来构建，暂时不考虑使用汇编语言编写应用程序，不同的高级语言会带有基础的开发工具库，比如Java的JDK、Go的标准库等等。考虑到这篇文章是写给大学时代的自己，我提出程序是如何运行的这个问题的时候，还是一个小白，我这里简单的介绍一下这些开发工具库，如果我们将一个应用程序理解为一个又一个建筑物，那么这些工具包就是建房子的基础材料。上面的比喻是一种类比分析方法，还是失真了一些，原因在于我们最终构建的应用程序需要经过打包工具或者命令行才能运行在对应的操作系统之上。

## 机器语言与指令集架构简介

 所谓的运行我们可以理解为翻译，将高级语言翻译成机器语言交给CPU执行，程序运行前将高级语言翻译成机器指令或低级代码的这个工作我们称之为编译器。在运行期将高级语言翻译成机器语言的我们称之为解释器。那什么是机器语言，我记得有一种观点是计算机只认识1和0，我想这种论断是从上面的层次图中的最后一层来说的，也就是晶体管。CPU将机器语言转换成电路信号, 粗略的说机器语言是CPU直接执行的指令，这些指令驱动CPU执行运算，我们将CPU支持所有的指令称之为指令集。



## 可执行文件





## JIT VS AOT





## 程序是如何执行的







## 总结一下

[1] 【纸带计算机】Elliott903现场演示  https://www.bilibili.com/video/BV1i64y1M7Sc/

[2]   Architecture  https://www.collinsdictionary.com/zh/dictionary/english/architecture 

[3]   计算机体系结构基础  https://foxsen.github.io/archbase/%E5%BC%95%E8%A8%80.html#%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E7%9A%84%E7%A0%94%E7%A9%B6%E5%86%85%E5%AE%B9

[4] difference-compiler-vs-interpreter https://www.guru99.com/difference-compiler-vs-interpreter.html

[5]  计算机语言是什么?  http://programarcadegames.com/index.php?chapter=what_is_a_computer_language&lang=cn

[6] Instruction Set Architecture   https://www.arm.com/glossary/isa

[7]  What is the difference between Instruction Set and Instruction Set Architecture (ISA)?   https://stackoverflow.com/questions/43293943/what-is-the-difference-between-instruction-set-and-instruction-set-architecture

